<?xml version="1.0"?>

<!-- ==========================================================================

James Functional Test build file.
This file provides targets for building the functional test harness,
and running a number of functional tests against a running instance of James.

Authors:
    Darrell DeBoer  <darrell@apache.org>

Legal:
  Copyright (c) 1999-2001 The Apache Software Foundation. All Rights Reserved.


==============================================================================
 -->

<project default="main" basedir="../..">

  <!--
    Give user a chance to override without editing this file
    (and without typing -D each time he compiles it)
  -->
  <property file=".ant.properties"/>
  <property file="${user.home}/.ant.properties"/>

  <!-- There should be no need to override default compiler but need to change
    javac task to run without this
  <property name="build.compiler" value="classic"/>-->

  <!--
    these are here only for those who use jikes compiler. For other
    developers this part makes no difference.
  -->
  <property name="build.compiler.emacs" value="on"/>
  <property name="build.compiler.pedantic" value="true"/>
  <property name="build.compiler.depend" value="true"/>
  <property name="build.compiler.fulldepend" value="true"/>

  <property name="debug" value="on"/>
  <property name="optimize" value="on"/>
  <property name="deprecation" value="off"/>


  <!-- Set the properties for build directory -->
  <property name="build.dir" value="build"/>
  <property name="build.test.classes" value="${build.dir}/test/classes"/>

  <!-- Set the properties for source directories -->
  <property name="proposal.base" value="proposals"/>
  <property name="proposal.dir" value="${proposal.base}/imap"/>
  <property name="java.proposal.dir" value="${proposal.dir}/java"/>
  <property name="conf.proposal.dir" value="${proposal.dir}/conf"/>
  <property name="test.dir" value="${proposal.dir}/test"/>
  <property name="lib.dir" value="lib"/>

  <!-- Set up the classpath -->
  <path id="project.class.path">
    <fileset dir="${lib.dir}">
        <include name="junit-3.7.jar"/>
        <include name="mail_1_2.jar"/>
        <include name="activation.jar"/>
    </fileset>
  </path>

  <!--
       ===================================================================
                                  Main target
       ===================================================================
  -->
  <target name="main" depends="compile" />


  <!-- Compiles the Functional tests -->
  <target name="compile">
    <mkdir dir="${build.test.classes}"/>

    <javac destdir="${build.test.classes}"
           debug="${debug}"
           optimize="${optimize}"
           deprecation="${deprecation}">
      <classpath refid="project.class.path" />
      <src path="${test.dir}"/>
    </javac>

    <!-- Copy extra files (resources) into the classes directory -->
    <copy todir="${build.test.classes}">
      <fileset dir="${test.dir}">
        <exclude name="**/*.java"/>
      </fileset>
    </copy>
  </target>
  
  <!-- Run the full set of Imap tests -->
  <target name="testimap" depends="testimap-init, testimap-nonauthenticated, testimap-authenticated, testimap-selected" />

  <!-- Initialises the IMAP server for running tests.
       Namely, creates the "imapuser" user, and sends 4 test messages to that user
       via SMTP
  -->
  <target name="testimap-init" depends="compile">
    <junit fork="yes">
        <classpath>
            <pathelement location="${build.test.classes}"/>
            <path refid="project.class.path"/>
        </classpath>
        <formatter type="plain" usefile="false"/>
        <test name="org.apache.james.imapserver.InitialUsers"/>
        <test name="org.apache.james.imapserver.InitialMail"/>
    </junit>
  </target>

  <!-- Tests IMAP commands valid in the NonAuthenticated state -->
  <target name="testimap-nonauthenticated" depends="compile">
    <junit fork="yes">
        <classpath>
            <pathelement location="${build.test.classes}"/>
            <path refid="project.class.path"/>
        </classpath>
        <formatter type="plain" usefile="false"/>
        <test name="org.apache.james.imapserver.TestNonAuthenticated"/>
    </junit>
  </target>

  <!-- Tests IMAP commands valid in the Authenticated state -->
  <target name="testimap-authenticated" depends="compile">
    <junit fork="yes">
        <classpath>
            <pathelement location="${build.test.classes}"/>
            <path refid="project.class.path"/>
        </classpath>
        <formatter type="plain" usefile="false"/>
        <test name="org.apache.james.imapserver.TestAuthenticated"/>
    </junit>
  </target>

  <!-- Tests IMAP commands valid in the selected state -->
  <target name="testimap-selected" depends="compile">
    <junit fork="yes">
        <classpath>
            <pathelement location="${build.test.classes}"/>
            <path refid="project.class.path"/>
        </classpath>
        <formatter type="plain" usefile="false"/>
        <test name="org.apache.james.imapserver.TestSelected"/>
    </junit>
  </target>

</project>

