<?xml version="1.0"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one   
  or more contributor license agreements.  See the NOTICE file 
  distributed with this work for additional information        
  regarding copyright ownership.  The ASF licenses this file   
  to you under the Apache License, Version 2.0 (the            
  "License"); you may not use this file except in compliance   
  with the License.  You may obtain a copy of the License at   
                                                               
    http://www.apache.org/licenses/LICENSE-2.0                 
                                                               
  Unless required by applicable law or agreed to in writing,   
  software distributed under the License is distributed on an  
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       
  KIND, either express or implied.  See the License for the    
  specific language governing permissions and limitations      
  under the License.                                           
 -->
<assembly>

  <!-- The list of blocks being run in this Phoenix server. -->
  <!-- -->
  <!-- Each block element has a name attribute that is unique -->
  <!-- among the blocks. It also has a class attribute that -->
  <!-- specifies the class providing that block-->
  <!-- -->
  <!-- The block element may have one or more provide sub-elements. -->
  <!-- Each provide element represents another block on which this -->
  <!-- block depends.  Phoenix will calculate a dependency chain when it -->
  <!-- reads this file, and will load and start the blocks in the order -->
  <!-- specified by that chain.  Each provide element has a name attribute, -->
  <!-- which matches the name of a block defined in this file.  It also -->
  <!-- has a role attribute.  This attribute is the string by which the -->
  <!-- enclosing block will identify the required block. -->
  <!-- -->

  <!-- The James block  -->
  <block name="James" class="org.apache.james.AvalonJames" >

    <!-- Specify which components will provide the services required by this
    block. The roles are specified in the code and the .xinfo file. The names
    here must match the names specified for a Block in this xml file.   -->
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="mailstore" role="org.apache.avalon.cornerstone.services.store.Store"/>
    <provide name="users-store" role="org.apache.james.api.user.UsersStore"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="spoolrepository" role="org.apache.james.services.SpoolRepository"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <provide name="domainlist" role="org.apache.james.api.domainlist.DomainList" />
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="scheduler"
             role="org.apache.avalon.cornerstone.services.scheduler.TimeScheduler"/>
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />   
    <provide name="defaultvirtualusertable"
             role="org.apache.james.api.vut.VirtualUserTable" />     
    <proxy disable='true'/>
  </block>
   
  <!-- The James Spool Manager block  -->
  <block name="spoolmanager" class="org.apache.james.transport.AvalonJamesSpoolManager" >
    <provide name="spoolrepository" role="org.apache.james.services.SpoolRepository"/>
    <provide name="matcherpackages" role="org.apache.james.transport.MatcherLoader"/>
    <provide name="mailetpackages" role="org.apache.james.transport.MailetLoader"/>
    <proxy disable='true'/>
  </block>

  <block name="matcherpackages" class="org.apache.james.transport.AvalonJamesMatcherLoader" >
    <provide name="James" role="org.apache.mailet.MailetContext"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="defaultvirtualusertable"
             role="org.apache.james.api.vut.VirtualUserTable" />
    <provide name="virtualusertable-store" role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <provide name="imapserver" role="org.apache.jsieve.mailet.Poster"/>
    <provide name="mailstore" role="org.apache.avalon.cornerstone.services.store.Store"/>
    <provide name="users-store" role="org.apache.james.api.user.UsersStore"/>  
    <proxy disable='true'/>
  </block>

  <block name="mailetpackages" class="org.apache.james.transport.AvalonJamesMailetLoader" >
    <provide name="James" role="org.apache.mailet.MailetContext"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="defaultvirtualusertable"
             role="org.apache.james.api.vut.VirtualUserTable" />
    <provide name="virtualusertable-store" role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <provide name="imapserver" role="org.apache.jsieve.mailet.Poster"/>
    <provide name="mailstore" role="org.apache.avalon.cornerstone.services.store.Store"/> 
    <provide name="users-store" role="org.apache.james.api.user.UsersStore"/>
    <proxy disable='true'/>
  </block>

  <block name="dnsserver" class="org.apache.james.dnsserver.AvalonDNSServer" />

  <!-- The Spool Management block  -->
  <block name="spoolmanagement" class="org.apache.james.management.impl.AvalonSpoolManagement" >
      <provide name="mailstore" role="org.apache.avalon.cornerstone.services.store.Store"/>
      <proxy disable='true'/>
  </block>
  
  <block name="processormanagement" class="org.apache.james.management.impl.AvalonProcessorManagement" >
      <provide name="spoolmanager" role="org.apache.james.services.SpoolManager"/>
      <proxy disable='true'/>
  </block>

  <block name="bayesiananalyzermanagement" class="org.apache.james.management.impl.AvalonBayesianAnalyzerManagement" >
      <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <proxy disable='true'/>
  </block>

  <block name="remotemanager" class="org.apache.james.remotemanager.AvalonRemoteManager" >
    <provide name="mailstore" role="org.apache.avalon.cornerstone.services.store.Store"/>
    <provide name="users-store" role="org.apache.james.api.user.UsersStore"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="connections"
             role="org.apache.james.socket.JamesConnectionManager"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <provide name="spoolmanagement" 
             role="org.apache.james.management.SpoolManagementService"/>
    <provide name="bayesiananalyzermanagement"
             role="org.apache.james.management.BayesianAnalyzerManagementService"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="processormanagement" role="org.apache.james.management.ProcessorManagementService"/>
    <provide name="virtualusertablemanagement" role="org.apache.james.api.vut.management.VirtualUserTableManagementService"/>
    <provide name="domainlistmanagement" role="org.apache.james.management.DomainListManagementService"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem" /> 
    <proxy disable='true'/>
</block>

  <!-- The User Management block  -->
  <block name="usermanagement" class="org.apache.james.impl.user.AvalonUserManagement" >
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="users-store" role="org.apache.james.api.user.UsersStore"/>
    <proxy disable='true'/>
  </block>
        
  <!-- POP3 Server -->
  <block name="pop3server" class="org.apache.james.pop3server.AvalonPOP3Server" >
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="connections"
             role="org.apache.james.socket.JamesConnectionManager"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem" /> 
    <proxy disable='true'/>
  </block>

  <!-- SMTP Server -->
  <block name="smtpserver" class="org.apache.james.smtpserver.AvalonSMTPServer" >
    <provide name="James" role="org.apache.mailet.MailetContext"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="org.apache.james.smtpserver.protocol.DNSService" role="org.apache.james.smtpserver.protocol.DNSService"/>
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="connections"
             role="org.apache.james.socket.JamesConnectionManager"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <provide name="defaultvirtualusertable"
             role="org.apache.james.api.vut.VirtualUserTable" />
    <provide name="virtualusertable-store" role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <proxy disable='true'/>
  </block>
  
  <!-- Async SMTP Server -->
  <!-- enable this to use the MINA based SMTP Server which uses NIO -->
  <!-- 
  <block name="smtpserver" class="org.apache.james.smtpserver.mina.AvalonAsyncSMTPServer" >
    <provide name="James" role="org.apache.mailet.MailetContext"/>
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="org.apache.james.smtpserver.protocol.DNSService" role="org.apache.james.smtpserver.protocol.DNSService"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>    
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <provide name="defaultvirtualusertable"
             role="org.apache.james.api.vut.VirtualUserTable" />
    <provide name="virtualusertable-store" role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <proxy disable='true'/>
  </block>
  -->

  <block name="org.apache.james.smtpserver.protocol.DNSService" class="org.apache.james.smtpserver.integration.SMTPServerDNSServiceAdapter" >
    <proxy disable='true'/>
  </block>
  
  <!-- NNTP Server -->
  <block name="nntpserver" class="org.apache.james.nntpserver.AvalonNNTPServer" >
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="connections"
             role="org.apache.james.socket.JamesConnectionManager"/>
    <provide name="nntp-repository"
             role="org.apache.james.nntpserver.repository.NNTPRepository"/>
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem" /> 
    <proxy disable='true'/>
  </block>

  <!-- NNTP Repository -->
  <block name="nntp-repository" class="org.apache.james.nntpserver.repository.AvalonNNTPRepository">
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <proxy disable='true'/>
  </block>

  <!-- FetchMail Service -->
  <block name="fetchmail" class="org.apache.james.fetchmail.AvalonFetchScheduler" >
    <provide name="scheduler"
             role="org.apache.avalon.cornerstone.services.scheduler.TimeScheduler"/> 
    <provide name="James" role="org.apache.james.services.MailServer"/>      
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <proxy disable='true'/>
  </block>
  
  <!-- JMS Service 
  EXPERIMENTAL JMS Service: uncomment before use
  <block name="jms" class="org.apache.james.phoenix.jms.activemq.JMSService" >
    <provide name="James" role="org.apache.james.services.MailServer"/>   
  </block>
  -->

  <!-- The High Level Storage block -->
    
  <block name="mailstore" class="org.apache.james.mailrepository.AvalonMailStore" >
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />     
    <proxy disable='true'/>
  </block>  
        
  <!-- The main SpoolRepository -->
  <block name="spoolrepository" class="org.apache.james.mailrepository.AvalonMailStoreSpoolRepository" >
    <provide name="mailstore"
             role="org.apache.avalon.cornerstone.services.store.Store" />
    <proxy disable='true'/>
  </block>

  <!-- The User Storage block -->
  <block name="users-store" class="org.apache.james.core.AvalonUsersStore" >
    <!-- Configure file based user store here, defaults should be fine -->
    <provide name="mailstore"
             role="org.apache.avalon.cornerstone.services.store.Store"/>
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector" />
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <proxy disable='true'/>
  </block>

  <!-- This is needed to link the smtpserver to the local user repository -->
  <!-- LocalJamesUsersRepository is used for backward compatibility with James 2.3.0 -->
  <!-- This is needed to support <usernames> configuraion inside James -->
  <!-- If backward compatibility is not need the LocalUsersRepository implementaion -->
  <!-- could be safely used -->
  <block name="localusersrepository" class="org.apache.james.impl.jamesuser.AvalonLocalJamesUsersRepository">
    <provide name="users-store"
             role="org.apache.james.api.user.UsersStore"/>
    <proxy disable='true'/>
  </block>

  <!-- The context FileSystem implementation -->
  <block name="filesystem" class="org.apache.james.context.AvalonFileSystem">
  </block>
  
  <!-- The VirtualUserTable Management block  -->
  <block name="virtualusertablemanagement" class="org.apache.james.impl.vut.AvalonVirtualUserTableManagement" >
    <provide name="virtualusertable-store" role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <provide name="defaultvirtualusertable" role="org.apache.james.api.vut.management.VirtualUserTableManagement" />
    <proxy disable='true'/>
  </block>
  
  <!-- VirtualUserTable Store -->
  <block name="virtualusertable-store" class="org.apache.james.core.AvalonVirtualUserTableStore">
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <proxy disable='true'/>
  </block>
  
  <block name="defaultvirtualusertable" class="org.apache.james.impl.vut.AvalonDefaultVirtualUserTable">
    <provide name="virtualusertable-store"
             role="org.apache.james.api.vut.VirtualUserTableStore"/>
    <proxy disable='true'/>
  </block>
  
  
  <!-- ######################################################################## -->
  <!-- The context domainlist implementation -->
  <block name="domainlist" class="org.apache.james.domain.AvalonXMLDomainList">
      <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
      <proxy disable='true'/>
  </block>
  
  <!--  JDBC implementation of the domainlist service-->
  <!--
  <block name="domainlist" class="org.apache.james.domain.AvalonJDBCDomainList">
      <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector"/>
      <provide name="filesystem" role="org.apache.james.services.FileSystem"/>
      <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
  </block>
  -->
  
  <!-- JDBC VirtualUserTable implementation of the domainlist service -->
  <!--
  <block name="domainlist" class="org.apache.james.vut.AvalonJDBCVirtualUserTable">
    <provide name="database-connections"
             role="org.apache.avalon.cornerstone.services.datasources.DataSourceSelector"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem"/>
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
  </block>
  -->
  
  <!-- XML VirtualUserTable implementation of the domainlist service -->
  <!--
  <block name="domainlist" class="org.apache.james.vut.AvalonXMLVirtualUserTable">
      <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
  </block>
  -->
  
    
  <!-- IMAP server -->
  <block name="imapserver" class="org.apache.james.imapserver.AvalonImapServer">
    <provide name="localusersrepository" role="org.apache.james.api.user.UsersRepository"/>
    <provide name="sockets"
             role="org.apache.avalon.cornerstone.services.sockets.SocketManager"/>
    <provide name="connections"
             role="org.apache.james.socket.JamesConnectionManager"/>
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <provide name="dnsserver" role="org.apache.james.api.dnsservice.DNSService"/>
    <provide name="James" role="org.apache.james.services.MailServer"/>
    <provide name="filesystem" role="org.apache.james.services.FileSystem" />
    <proxy disable='true'/>
  </block>
  
  <!-- #################################################################### -->
  
  <block name="domainlistmanagement" class="org.apache.james.management.impl.AvalonDomainListManagement">
    <provide name="domainlist"
             role="org.apache.james.api.domainlist.DomainList"/>
    <proxy disable='true'/>
  </block>
  
  <!-- Configuration for Cornerstone Blocks only after here
       NOTHING BELOW THIS SHOULD NEED CHANGING,
       (unless you want secure sockets (TLS)) -->

  <!-- The Connection Manager block -->
  <block name="connections"
         class="org.apache.james.socket.AvalonSimpleConnectionManager" >
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <proxy disable='true'/>
  </block>

  <!-- The Socket Manager block -->
  <block name="sockets"
         class="org.apache.avalon.cornerstone.blocks.sockets.DefaultSocketManager">
   <proxy disable='true'/>
  </block>

  <!-- The Time Scheduler block -->
  <block name="scheduler"
         class="org.apache.avalon.cornerstone.blocks.scheduler.DefaultTimeScheduler" >
    <provide name="thread-manager"
             role="org.apache.avalon.cornerstone.services.threads.ThreadManager" />
    <proxy disable='true'/>
  </block>

  <!-- The DataSourceSelector block -->
  <block name="database-connections"
         class="org.apache.avalon.cornerstone.blocks.datasources.DefaultDataSourceSelector" >
         <proxy disable='true'/>
  </block>

  <!-- The ThreadManager block -->
  <block name="thread-manager"
         class="org.apache.avalon.cornerstone.blocks.threads.DefaultThreadManager" >
         <proxy disable='true'/>
  </block>

  <listener name="JamesLoader" class="org.apache.james.phoenix.PhoenixLoader"/>
</assembly>
