<?xml version="1.0"?>

<document>

 <properties>
  <title>Migrating from Avalon database connections to DataSource</title>
  <author email="serge@apache.org">Serge Knystautas</author>
 </properties>

<body>

<section name="Migrating from Avalon database connections to DataSource">

<p>
  In James version 3.0, we expose database connections via the javax.sql.DataSource.  This document describes how to update code using James previous database connectivity (Avalon's DataSourceComponent).
</p>
<ol>
<li>Remove references to DataSourceSelector.</li>
<li>Change references of DataSourceComponent to DataSource</li>
<li>Add imports:
<source>
import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;
</source>
</li>
<li>Change how the datasource is looked up
<br />
Replace:
<source>
    ComponentManager componentManager = (ComponentManager)getMailetContext().getAttribute(Constants.AVALON_COMPONENT_MANAGER);
    // Get the DataSourceSelector service
    DataSourceSelector datasources = (DataSourceSelector)componentManager.lookup(DataSourceSelector.ROLE);
    // Get the data-source required.
    datasource = (DataSourceComponent)datasources.select(datasourceName);
</source>
with
<source>
    InitialContext ctx = new InitialContext();
    datasource = (DataSource) ctx.lookup("java:comp/env/jdbc/" + datasourceName);
</source>
Then update exception handling appropriately.
</li>
</ol>
 <p>
   That's all there is to it.  Enjoy!
 </p>

</section>
</body>
</document>
