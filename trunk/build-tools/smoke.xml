<?xml version="1.0"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->

<project default="help" basedir="." name="smoke-test" 
    xmlns:mpt="antlib:org.apache.james.mpt.ant"> 

	<description>
	Contains smoke test macros. These allow basic sanity testing of the packaged distribution
	</description>
	
	<target name='help'>
		<echo>This is a library containing macros required for smoke tests.</echo>
	</target>
 
    <macrodef name='RunSmokeTests'>
        <sequential>   
            <taskdef 
                uri="antlib:org.apache.james.mpt.ant" 
                resource="org/apache/james/mpt/ant/antlib.xml">
                <classpath>
                    <pathelement location="${lib.dir}/${mpt.jar}" />
                    <pathelement location='${lib.dir}/${mpt-antlib.jar}' />
                </classpath>
            </taskdef>  
            
            <mpt:mpt port='10043' script='../build-tools/imap.mpt'>
                <addUser port='10445' user='user' passwd='passwd'>S: JAMES Remote Administration Tool 3.0-SNAPSHOT
S: Please enter your login and password
S: Login id:
C: root
S: Password:
C: root
S: Welcome root. HELP for a list of commands
C: adduser user passwd
S: User user added
</addUser>
            </mpt:mpt>
        </sequential>   
    </macrodef>   
        
    <macrodef name='Smoke'>
        <attribute name='build-dir'/> 
        <attribute name='zip'/>    
        <attribute name='package'/>
        <attribute name='app-path'/>
        <attribute name='conf-path'/>
        <attribute name='conf-file-name'/> 
        <attribute name='cmd'/>
        <sequential>
    
            <VerifySmokePrerequisites zip='@{zip}'/>
        
            <property name='smoke.dir' location='@{build-dir}/smoke'/>
            <UnpackDistribution zip='@{zip}' dir='${smoke.dir}'/>
            
            <property name='smoke.james.dir' location='${smoke.dir}/@{package}'/>               
            <ConfigureJames 
            	dir='${smoke.james.dir}' 
            	app-path='@{app-path}' 
            	conf-path='@{conf-path}'
            	conf-file-name='@{conf-file-name}'/>   
            <BootJames dir='${smoke.james.dir}' cmd='@{cmd}'/>  
            <RunSmokeTests/>   
            <StopJames dir='${smoke.james.dir}' cmd='@{cmd}'/>       
    
        </sequential>   
    </macrodef> 
    
    <macrodef name="ControlJames">
        <attribute name='action'/>
        <attribute name='dir'/>   
        <attribute name='cmd'/>
        <sequential>
            <chmod 
                perm="ugo+rx" 
                file="@{dir}/bin/@{cmd}.sh"/>   
            <exec 
               dir="@{dir}/bin" 
               executable="@{dir}/bin/@{cmd}.sh" 
               failonerror='true'>
                <arg line="@{action}"/>
            </exec> 
        </sequential>   
    </macrodef>  
 
    <macrodef name="StartJames">
        <attribute name='dir'/> 
        <attribute name='cmd'/>  
        <sequential>
            <ControlJames dir='@{dir}' action='start' cmd='@{cmd}'/>
        </sequential>   
    </macrodef>  
 
    <macrodef name="StopJames">
        <attribute name='dir'/>
        <attribute name='cmd'/>    
        <sequential>
            <ControlJames dir='@{dir}' action='stop' cmd='@{cmd}'/>
        </sequential>   
    </macrodef>    
    
    <macrodef name='BootJames'>
        <attribute name='dir'/> 
        <attribute name='cmd'/>   
        <sequential>
            <StopJames dir='@{dir}' cmd='@{cmd}'/>   
            <StartJames dir='@{dir}' cmd='@{cmd}'/>
            <echo>Waiting for James to boot...</echo>   
            <waitfor maxwait='45' maxwaitunit='second' timeoutproperty='smoke.boot.failed'>
                <and>   
                    <socket server='localhost' port='10025'/>   
                    <socket server='localhost' port='10110'/>
                    <socket server='localhost' port='10043'/>
                    <socket server='localhost' port='10119'/>   
                    <socket server='localhost' port='10445'/>   
                </and>   
            </waitfor>   
            <fail if='smoke.boot.failed'>
Failed to boot James server. See @{dir}/temp/phoenix.console for details.   
            </fail>   
                <echo>James booted.</echo>      
        </sequential>   
    </macrodef>   
 
    <macrodef name='ConfigureJames'>
    	<attribute name='dir'/>
        <attribute name='app-path'/>
        <attribute name='conf-path'/>
        <attribute name='conf-file-name'/>  
        <sequential>
            <unzip dest="@{dir}/@{app-path}/james">
            	<fileset dir='@{dir}/@{app-path}'>
            		<include name='james.sar'/>
            	</fileset>
            </unzip>
            <xslt 
            	style="../build-tools/smoke.xsl" 
                in='@{dir}/@{conf-path}/@{conf-file-name}' 
                out='@{dir}/@{conf-path}/config-smoke.xml'></xslt>
            <move   
                file='@{dir}/@{conf-path}/config-smoke.xml' 
                tofile="@{dir}/@{conf-path}/@{conf-file-name}"/>
        </sequential>   
    </macrodef>   

    <macrodef name='VerifySmokePrerequisites'>
    	<attribute name='zip'/>
        <sequential>
            <condition property='is.windows'>
                <os family='windows'/>   
            </condition>   
            <fail if='is.windows'>
Smoke is not supported on Windows ATM.
To support smoke on Windows, a reliable method of shutting down
James from the command line is required on Windows.   
            </fail>   
            <available file='@{zip}' property="is.packaged"/>
            <fail unless='is.packaged'>
@{zip} not found. Try 'ant dist'.
            </fail>  
        </sequential>
    </macrodef>   
 
    <macrodef name='UnpackDistribution'>
        <attribute name='dir'/>
        <attribute name='zip'/>   
        <sequential>
            <delete dir='@{dir}'/>       
            <mkdir dir='@{dir}'/>   
            <unzip src='@{zip}' dest='@{dir}'/>    
        </sequential>
    </macrodef>    
</project>